---
id: di
title: Dependency Injection
---

В основе tramvai работает `DI` система, которая содержит в себе информацию о зависимостях, связи между ними, и уже созданные экземпляры зависимостей.

## Концепции

- [Провайдер](concepts/provider.md) - Имплементация токена в DI
- [Токены](concepts/provider.md) - индетификатор провайдера в DI системе и одновременно его интерфейс
- Контейнер - хранилище со всеми провайдерами и их реализациями

## Особенности

### Динамическая инициализация

Провадйры инициализируются только если в коде прозошло получение инстанса с помощью метода `get` у di контейнера или если провайдер был указан как `deps` зависимость у `module`. В остальных случаях провайдер не будет создан и проинициализирован.

Эта особенность позволяем нам регистрировать провайдеры в любой последовательности и заменять реализации.

### Замена реализаций

В некоторых случаях, нам может не подойти базовая реализация функционала и для решения этой проблемы, мы можем переопределить реализацию провайдеров. К примеру нам не подходит текущий логгер из common-module и мы хотим его заменить, для этого нам необходимо закинуть в `providers` новую реализацию для токена.

```tsx
import { provide } from '@tramvai/core';
createApp({
  modules: [CommonModule],
  providers: [
    provide({
      provide: LOGGER_TOKEN,
      useValue: console,
    }),
  ],
});
```

После этого, мы заменим реализацию `LOGGER_TOKEN`, которая была объявлена в `CommonModule`, на нативный объект `console`

### Проверка доступности реализации всех зависимостей

При инициализации провайдера автоматически проверяется доступность всех зависимостей, если не была найдена зависимость и провайдер не является optional, в development режиме выбрасывается исключение.

## Использование DI

### В модулях

Передача массива в параметр `providers` который будут добавлены при инициализации приложения в DI. [Подробнее о модулях](concepts/module.md)

```tsx
@Module({
  providers: [
    // ...
  ],
})
export class MyModule {}
```

### В createApp

Можно передать в [createApp](references/tramvai/create-app.md) массив `providers`, который будет иметь максимальный приоритет и перепишет реализации интерфейсов модулей и core:

```tsx
createApp({
  providers: [
    // ...
  ],
});
```

### В экшенах

Для получшения реализаций провайдеров, можно передать объект `deps` при создании экшена:

```tsx
createAction({
  name: 'action',
  fn: (context, payload, deps) => {
    deps.logger.error('ERROR');
  },
  deps: {
    logger: 'logger',
  },
});
```

## Контейнер

Контейнер в котором хранится список зарегистрированных провайдеров в приложении, так и инстансы реализаций провайдеров, которые уже были созданы.

### Корневой контейнер

Глобальный контейнер верхнего уровня, который содержит в себе всех зарегистрированых провайдеров и глобальные синглтоны которые живут все время, пока живет приложение.

### Контейнер - потомок

Создаваемый для каждого клиента (пользователя, отправившего запрос на сервер) инстанс DI который наследуется от root контейнера. Но позволяет создавать и хранить собственные инстансы классов. Которые могут содержать приватную информацию о клиенте и при этом, эта информация не утечет другим клиентам, например ссылка на актуальный объект Request.

Consumer di создается и живет пока мы отвечаем клиенту. Как только мы ответили, consumer di удаляется и очищается вся приватная информация. При этом не нужно делать ручную очистку и удалять di контейнер или его зависимости. Это работа основывается на том, что при ответе клиенту, теряется ссылка на контекст и DI контейнер. После чего GC удалит все из памяти.

## Дополнительный материал

- Видео с рассказом о том, зачем нужен DI и почему его стоит использовать [Part 1](https://www.youtube.com/watch?v=ETyltCwtQHs) [Part 2](https://www.youtube.com/watch?v=RwLWYB9C2Tc)
- Выпуск девшахты который посвещен DI и зачем он нужен https://www.youtube.com/watch?v=3NgWwzwDeTQ
