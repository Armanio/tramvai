---
id: deploy
title: Deploy приложения
---

## Общее

Tramvai это обычное node.js приложение которое можно запустить стандартными инструментами доступными в node.js комьюнити. Ограничения только накладываются на файловую структуру и необходимости передать ENV переменные приложению

## Список действий необходимых для деплоя приложения

- собрать приложение в продакшен режиме
- залить ассеты
- сбилдить докер контейнер с файлами приложения
- запустить, передав ENV переменные

### Сборка проекта

Для сборки проекта необходимо использовать команду (перед этим установив зависимости в проекте)

```bash
tramvai build APP_ID
```

в APP_ID необходимо передать идентификатор приложения. После выполнения команды появится директория `dist` с файлами сборки сервера и клиентского кода

### Создание докер контейнера

Рекомендуемый Dockerfile

```dockerfile
FROM node:14-buster-slim
WORKDIR /app
COPY dist/server /app/
COPY package.json /app/
ENV NODE_ENV='production'

EXPOSE 3000
CMD [ "node", "--max-http-header-size=80000", "/app/server.js" ]
```

- `FROM` - можете поставить 14+ версию ноды, желательно alpine версию для снижения размера

### Заливки клиенской статики

Рекомендуемый способ это заливка файлов на CDN, так как node.js не очень хорошо справляется с раздачей статики, так и будет большой трафик для нашей инфрастуктуры. По этому для продакшен приложений, которые будут использовать клиенты, стоит всегда испольвать CDN. 

Для этого, содержимое папки `dist/client` заливаете на CDN по выбранному вами способу, получается URL по которому будут доступны файлы и подставляете этот урл в ENV переменную `ASSETS_PREFIX` например `ASSETS_PREFIX=https://cdn-domain.com/my-awesome-app/`

Если вам не нужен CDN, то можете посмотреть ниже в пункте "Запуск приложения без клиентского CDN", стоит использовать для тестовых стендов или не нагруженных приложений

### Деплой приложения

Приложение запускается как обычный node.js процес командой node, при запуске необходимо передать все необходимые ENV переменные (список ENV зависит от используемых модулей приложением). Если не добавить ENV переменные - то приложение не запустится. Не забудьте про переменную `ASSETS_PREFIX`

## Explanation

### Пробы

Если вы деплоетесь в kubernetes, то для этих кейсов есть специальные урлы для проб которые необходимо использовать

- `/healthz` - после старта приложения всегда отдает ответ OK
- `/readyz` - после старта приложения всегда отдает OK

### Запуск приложения без клиентского CDN

В трамвай встроен сервер отдачи статики. Так лучше не делать, по той причине что nodeJS не лучший инструмент для этого и статика будет влиять на приложение.

В общем виде все то же самое как и при обычном деплое, но необходимо добавить копирование ассетов пользователя, в docker образ, для этого:
* добавить копирование файлов `COPY dist/client /app/public/statics`
* изменить ENV переменную ASSETS_PREFIX

Пример готового Dockerfile
```dockerfile
FROM node:14-buster-slim
WORKDIR /app
COPY dist/server /app/
COPY package.json /app/
COPY dist/client /app/public/statics
ENV NODE_ENV='production'

EXPOSE 3000
CMD [ "node", "--max-http-header-size=80000", "/app/server.js" ]
```

При запуске приложения необходимо передать `ASSETS_PREFIX=/statics/`. При старте приложения поднимется сервер отдачи статитики и будет доступны все файлы внутри директории /public/. Тем самым клиент сможет получить данные по урлу /statics/payment.js

### Локальный запуск в docker контейнере

На устройстве должен быть установлен https://www.docker.com/products/docker-desktop и выполняться команда `docker run hello-world`

#### Собираем проект в продакшен режиме, у нас появится артифакт в директории dist

```bash
yarn build
```

#### Собираем докер образ приложения

```bash
docker build -t test/myapp .
```

#### Запускаем собранный образ

```bash
docker run --rm -e DANGEROUS_UNSAFE_ENV_FILES='true' -e ASSETS_PREFIX='http://localhost:4000/static/' -v ${PWD}/env.development.js:/app/env.development.js -v ${PWD}/dist/client:/app/static  -e DEV_STATIC=true -p 3000:3000 -p 4000:4000 -d test/myapp
```

Для остановки контейнера нужно получить CONTAINER ID, выполним команду docker ps и далее выполнить команду docker stop <CONTAINER ID\>

#### Для остановки всех контейнеров

```bash
docker kill $(docker ps --quiet)
```
