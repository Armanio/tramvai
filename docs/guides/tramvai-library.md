---
id: tramvai-library
title: Создание tramvai библиотеки
---

Добавление новой библиотеки или модуля в репозитории `tramvai` подробно рассмотрено в разделе [Contribute](contribute/contribute.md)

Этот гайд содержит набор советов для разработки отдельных `tramvai` пакетов в репозиториях приложений,
также многие команды поддерживают отдельные монорепы с общими пакетами для ряда приложений, разделенных по разным репозитриям.

### Предпосылки

Рассмотрим все важные кейсы на примере создания нового `tramvai` модуля.
Допустим, модуль будет предоставлять новый HTTP клиент для работы с `API` Github.

### Название пакета

Крайне не рекомендуется использовать скоупы `@tramvai` и `@tramvai-tinkoff` вне репозитория `tramvai`.
Если наше приложение называется `tincoin`, можно например выбрать один из таких скоупов:

- `@tincoin`
- `@tramvai-tincoin`
- `@tincoin-core`

Для модулей, как правило используется префикс `module-`, например: `@tramvai-tincoin/module-github-api-client`

### Версионирование

Выбор стратегии версионирования исключительно за вами.
Мы определенно рекомендуем следовать `semver`, и можем рекомендовать использовать [сквозное версионирование](concepts/versioning.md), если:

- вы поддерживаете монорепу с core библиотеками
- эти библиотеки могут быть связаны между собой
- и эти пакеты используются в приложениях все вместе (или большинство из них)

### Dependencies

Работа с зависимостями у библиотек - не простая задача, и не имеет идеального решения, но есть ряд советов, упрощающих управление зависимостями.
Лучше всего начать с разделения зависимостей на различные типы:

#### Framework

Пример таких зависимостей - `react` и `react-dom`, `@tramvai/*` и `@tramvai-tinkoff/*`.
Если мы пишем `babel` или `eslint` плагин, то это могут быть `@babel/core` и `eslint`.

Как правило, конечный пользователь, например `tramvai` приложение, обязано устанавливать фреймворк зависимости,
без них оно просто не будет работать.

Поэтому наша библиотека должна устанавливать их в `peerDependencies`, с максимально свободными версиями, например если пакет завязан на базовый функционал `tramvai`, и использует React хуки:

```json
{
  "peerDependencies": {
    "@tramvai/core": "*",
    "react": ">=16.8",
    "react-dom": ">=16.8"
  }
}
```

#### Singleton

Ряд зависимостей должен быть строго один в приложении.
Любые дубликаты это минус, т.к. увеличивают вес бандла приложения, но такие библиотеки как `react` или `@tinkoff/logger` требуют быть в единственном экземпляре в нашем приложении.

Для них действует правило как с framework, надо устанавливать их в `peerDependencies`, с максимально свободными версиями:

```json
{
  "peerDependencies": {
    "@tinkoff/logger": "*"
  }
}
```

#### Popular

Многие пакеты достаточно популярны, и большая вероятность, что они уже используются в конечном приложении.
Пример таких зависимостей - `date-fns`, `lru-cache`, `@tinkoff/dippy`

Для них действует правило как с framework, надо устанавливать их в `peerDependencies`, с максимально свободными версиями:

```json
{
  "peerDependencies": {
    "@tinkoff/dippy": "*",
    "date-fns": ">=2",
    "lru-cache": "*"
  }
}
```

#### Specific

Допустим, наш новый tramvai модуль поставляет в приложение уникальный функционал, для которого требуется сторонняя библиотека (или даже другой пакет в вашей монорепе)

Если мы разрабатываем сервис для работы с API Github, это может быть пакет `@octokit/rest`.

В таком случае, нужно ставить библиотеку в `dependencies`, и можно оставить стандартный range с помощью `^`:

```json
{
  "dependencies": {
    "@octokit/rest": "^18.0.0"
  }
}
```

#### Development

Завимость может участвовать в сборке вашего пакета - например `rollup` или `@tramvai/build`.
Зависимость требуется для запуска тестов библиотеки.
Зависимость содержит необходимые для сборки тайпинги.

Во всех этих случаях, даже если либа уже есть в `peerDependencies`, стоит добавить более конкретную версию в `devDependencies`, например:

```json
{
  "devDependencies": {
    "@tramvai/build": "^2.5.0",
    "@types/react": "^17.0.0",
    "react": "^17.0.0"
  }
}
```

#### Исключения

Конечно, есть исключительные кейсы.

Например, tramvai предоставляет множество тестовых утилит, где все основные `@tramvai` зависимости были в `peerDependencies`.
Как только эти утилиты начали использовать не в репозиториях с приложениями, а в монорепах с core пакетами, появилась проблема отсутствующих зависимостей, и мы перенесли почти все из `peerDependencies` в `dependencies`

Действуйте по ситуации, и всегда думайте об удобстве использования вашего продукта :)

### Сборка

Предполагается, что итоговую сборку пакетов в контексте приложения будет осуществлять `@tramvai/cli`.
Поэтому, для публикации пакетов, написанных на `TypeScript`, достаточно использовать `tsc`, и публиковать множество собранных `.js` и `.d.ts` файлов.

Но сборка пакетов в бандлы перед публикацией, например через `rollup` или `@tramvai/build`,  дает ряд возможностей:

- предварительный tree-shaking отсечет все лишнее, это положительно скажется на сборке приложения
- можно сделать несколько бандлов для разного окружения, в CJS или ES modules форматах
- можно сделать отдельный бандл для браузерной сборки, отдельный для серверной - топ для библиотек с поддержкой SSR 

Подробная документация про использование `@tramvai/build` доступна в [документации](references/tools/build.md)
