---
id: bundle-optimization
title: Оптимизация бандла
---

[@tramvai/cli](references/cli/base.md) использует `webpack` для сборки приложения, и настраивает большинство известных оптимизация для production сборки - минификация и обфускация кода, оптимизация CSS и изображений, code splitting, хэши для эффективного кэширования статики - и позволяет настраивать некоторые этапы оптимизации.

## Code Splitting

Предоставление клиенту минимально необходимого JavaScript кода является одной из самый важных вещей в оптимизации web-приложений. Разделение точек входа при сборке бандлов и динамический `import` модулей, и использование этих банлов на основе роутинга / пользовательских действий - основные механизмы разделения кода. При сборке множества бандлов и динамических чанков возникает проблема дублирования кода между ними, которую позволяет решить [SplitChunksPlugin](https://webpack.js.org/plugins/split-chunks-plugin/)

Tramvai приложения имеют ряд особенностей - единая точнка входа (`platform.js` на выходе), динамический импорт на уровне каждого [bundle](concepts/bundle.md), отдельная сборка vendor чанка. Для приложения, имеющего несколько tramvai бандлов под разные страницы, каждая страница будет загружать как минимум чанк `platform.js` с общим кодом фреймворка и модулей, и чанк `{bundleName}.js` с уникальным кодом для страницы. Дубликаты могут быть в чанках, созданных под tramvai бандлы (например компоненты ui-kit), и этот код желательно вынести в общие чанки.

CLI предлагает три стратегии для разделения кода - один общий common чанк, множество granular чанков, и отключение SplitChunksPlugin.

### Отключение SplitChunksPlugin

Для приложений, которые имеют только один tramvai бандл на все страницы, либо разделяют бандл для десктопной и мобильной версии, в большинстве случаев не требуется разделение кода, и стоит выставить опцию `"commonChunk": false`:

```json
{
  "projects": {
    "{appName}": {
      "commands": {
        "build": {
          "configurations": {
            "commonChunk": false
          }
        }
      }
    }
  }
}
```

**Почему не оставить common чанк, если он не мешает?** Проблема в сторонных библиотеках, которые могут использовать динамический `import` под капотом, при этом приложение может не использовать этот код, но он может попасть в common чанк, который будет загружаться на каждой странице.

Также, если приложение обслуживает множество страниц, и разделяет код на уровне page компонентов через [@tramvai/react lazy](how-to/how-create-async-component.md), имеет смысл рассмотреть другие стратегии, т.к. появятся дубликаты в динамических чанках страниц.

### Common Chunk

Стратегия включена в CLI по умолчанию, весь общий код из бандлов и динамических чанков выносится в `common-chunk.js`. Параметр `commonChunkSplitNumber` позволяет указать, какое минимальное количество чанков должно использовать этот код, что бы вынести его в common.

Для приложений с большим количеством бандлов, `common-chunk.js` может включать огромное количество кода, которое не нужно на каждой отдельной странице, и стоит либо увеличить `commonChunkSplitNumber`, либо использовать стратегию Granular Chunks. Пример конфигурации для увеличения минимального количества чанков, использующих общий код:

```json
{
  "projects": {
    "{appName}": {
      "commands": {
        "build": {
          "configurations": {
            "commonChunkSplitNumber": 5
          }
        }
      }
    }
  }
}
```

**Как выбрать подходящее число `commonChunkSplitNumber`?** Как вариант, число можно вычислить по формулам `commonChunkSplitNumber = bundles / 3` или `commonChunkSplitNumber = bundles / 2`, где bundles - это количество tramvai бандлов, которые подключаются в конкретное приложение, но скорее всего каждое приложение будет лучше рассматривать отдельно.

### Granular Chunks

[Подробное описание использования стратегии в Next.js и Gatsby.js](https://web.dev/granular-chunking-nextjs/)

Стратегия включается через параметр `granularChunks`, позволяет вынести общий код во множество мелких чанков, для эффективного кэширования общего кода, и загрузки на каждую страницу только нужного кода. Баланс достигается за счет того, что общий код как минимум между двумя (настройки по умолчанию) чанками выносится в отдельный чанк с уникальным именем, и таких чанков будет от одного на все остальные, до одного на каждые два чанка.

Недостатки этой стратегии: на одну страницу может загружаться значительно больше js скриптов, до нескольких десятков, что не значительно влияет на производительность при использовании HTTP/2; и менее эффективная gzip/brotli архивация, что не так заметно по сравнению с уменьшением количества исходного кода.

Параметр `granularChunksSplitNumber` позволяет переопределить число общих чанков по умолчанию (`2`), если по каким-то причинам необходимо уменьшить количество итоговых чанков:

```json
{
  "projects": {
    "{appName}": {
      "commands": {
        "build": {
          "configurations": {
            "granularChunks": true,
            "granularChunksSplitNumber": 3
          }
        }
      }
    }
  }
}
```
