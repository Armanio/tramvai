---
id: migration
title: Автоматические миграции
---

Автоматические миграции позволяют обновлять код и настройки приложения при обновлении в самом приложении версий трамвайных модулей или пакетов.

## Зачем нужны миграции

Иногда в трамвае бывает необходимость внести какие-то ломающие изменения и чтобы упростить такой переход для конечных пользователей используются автоматические миграции, т.к. миграции позволяют перевести кодовую базу приложения на новую версию интерфейсов в автоматическом режиме и практически без участия разработчиков.

## Как использовать миграции

Миграции выполняются автоматически при установке новых версий пакетов трамвая. Для сохранения информации об уже выполненных миграциях используется файл `.tramvai-migrate-applied.json` в корне проекта.

Всё что остается сделать разработчикам приложений:

- изучить доку по [последним миграциям для пакетов](https://tramvai.dev/docs/releases/migration)
- закомитить изменения в файле `.tramvai-migrate-applied.json`, т.к. в нем сохраняется игформация о выполненных миграциях и лучше его сохранить чтобы не выполнять миграции повторно
- если после миграций изменился `package.json`, то необходимо выполнить установку пакетов чтобы обновился lock файл в проекте.
- проревьювить и закомитить все остальные изменения которые произошли в проекте (ревью необходимо т.к. в миграции сложно учесть все кейсы использований, а также результат после преобразования кода может не соответсвовать настройкам линтера в текущем проекте).
- проверить работу приложения на наличие проблем и внести изменения в соответсвии с докой по миграции

## Как отключить миграции

Добавить переменную окружения `SKIP_TRAMVAI_MIGRATIONS` перед запуском установки пакетов.

## Как работают миграции

1. `@tramvai/core` содержит зависимость `@tramvai/tools-migrate`
1. в `@tramvai/tools-migrate` содержится скрипт который выполняется на 'postinstall'
1. скрипт выполняет анализ tramvai модулей в 'node_modules' и находим все миграции
1. дальше проверяется файл `.tramvai-migrate-applied.json` и из него берется список уже выбранных миграций если такой файл есть
1. выполняется код миграций, которых нет в списке выполненных. Миграции выполняются последовательно
1. в файл `.tramvai-migrate-applied.json` добавляется информация о только что выполненных миграциях, если файл был до этого, либо этот файл создаётся

## Вопросы/ответы
### Нужно ли хранить `.tramvai-migrate-applied.json` в гите

Да, иначе при следующих миграциях мы не будем знать какие миграции уже были выполнены и будут произведены повторные миграции
