# @tramvai/module-mocker

Модуль подключает библиотеку [@tinkoff/mocker](references/libs/mocker.md) в `tramvai` приложение, и делает доступным мокер на [papi](references/modules/server.md#papi) роуте `/mocker`.

## Подключение

Необходимо установить `@tramvai/module-mocker`:

```bash
yarn add @tramvai/module-mocker
```

Создать первый мок, в файле `mocks/my-api.js`, где свойство `api` должно содержать env переменную с урлом API, который требуется мокировать, в данном случае `MY_API`:

```tsx
module.exports = {
  api: 'MY_API',
  mocks: {
    'GET /endpoint?foo=bar': {
      status: 200,
      headers: {},
      payload: {
        result: {
          type: 'json',
          value: {
            a: 'b'
          },
        },
      },
    },
  },
};
```

Подключить модуль в проекте:

```tsx
import { createApp } from '@tramvai/core';
import { MockerModule } from '@tramvai/module-module';

createApp({
  name: 'tincoin',
  modules: [ MockerModule ],
});
```

Запустить приложения с env переменной `MOCKER_ENABLED`, например:

```bash
MOCKER_ENABLED="true" tramvai start tincoin
```

После этого, все запросы на `MY_API` и на клиенте и на сервере автоматически будут отправлены в мокер, а если не нашлось подходящих моков, проксируются в оригинальное API.

## Explanation

Особенности мокера описаны в [документации библиотеки](references/libs/mocker.md#Explanation).

Модуль подключает middleware мокера на `papi` роуте `/mocker`, и заменяет все `env` переменные мокируемых API ссылками на `papi`, подходящие для серверного и для клиентского кода.

По умолчанию, мокируются все API, которые были найдены в моках, это поведение можно переопределить.

Мокер подключается только при наличии env переменной `MOCKER_ENABLED="true"`.

### Замена env переменных

Допустим, приложение имеет env переменную `MY_API: https://www.my-api.com/`, и для этого API зарегистрирован мок.

Модуль рассчитан на работу локально, на динамических стендах, и в test/stage окружениях, это порождает сложность с определением пути до `papi` эндпоинта:

1. На сервере мы должны делать запрос по абсолютном пути, и тут приложение всегда доступно на `localhost`, значит env переменные заменяются на урлы вида `http://localhost:3000/tincoin/papi/mocker/MY_API/`

1. На клиенте, на стендах мы не знаем текущий домен приложения, и надо делать запросы по относительным путям, поэтому клиентские env переменные заменяются на урлы вида `/tincoin/papi/mocker/MY_API/`

Благодаря этой замене, все запросы приложения на мокируемое API, клиентские и серверные, автоматически отправляются в мокер.

## How to

### У меня есть моки для нескольких API, как мокировать только одно из них?

По умолчанию все API считываются из моков при старте приложения.
Это поведение можно переопределить, передавая список API для мокирования при инициализации модуля:

```tsx
MockerModule.forRoot({
  config: () => ({
    apis: ['MY_API'],
  }),
});
```

##  Экспортируемые токены

@inline src/tokens.ts
