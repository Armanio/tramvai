# Вставка inline-кода для клиента на сервере

Иногда есть необходимость собрать js-код на сервере, чтобы вставить его в начальный рендер html. Проблема возникает если версия EcmaScript, используемая для генерации кода не поддерживается браузером клиента (такое обычно случается потому, что на мы пишем es2015+ код и не учитываем, что некоторые клиенты используют устаревшие браузеры с es5). А даже если код и транспилируется на сервере, то он транспилируется под определённую версию nodejs, что не подходит для браузеров.

## Решение

Для клиента с помощью webpack + babel уже и так происходит транспиляция кода для работы в нужных браузерах. Поэтому нам по сути остаётся специальным образом указать, что некий код предназначен для клиента и потому его нужно собрать особым образом.

Правила для сборки определённого кода для клиента:

- код для вставки должен быть вынесен в отдельный файл
- в самом файле не должно быть импортов других модулей - на клиенте импорты требуют runtime вебпака, который не знает о тех файлах, которые используются на сервере
- сам код должен быть оформлен в виде экспортируемых функций и эти функции могут использовать только переданные ей аргументы, использование внешних переменных вне тела функции запрещены
- имя файла должно оканчиваться на `.inline(.es)?.[tj]s` - это работает как флаг, указывающий что файл надо собрать клиентским конфигом
- вместо инлайн кода вставляется как строка вызова экспортируемой функции с передачей ей аргументов - благодаря тому, что для функции преобразование в строку вернёт тело этой функции в виде строки, такая вставка будет работать

### Пример

1. Создадим файл с инлайн кодом `test.inline.ts`

   ```ts
   export const test = (arg: string) => {
     class Test {
       log() {
         console.log({
           arg,
           a: 1,
         });
       }
     }

     const t = new Test();

     t.log();
   };
   ```

2. Теперь импортируем функцию и вставляем её в начальный html

   ```ts
   import { Module } from '@tramvai/core';
   import { RENDER_SLOTS, ResourceType, ResourceSlot } from '@tramvai/module-render';
   import { test } from './test.inline';

   @Module({
     providers: [
       {
         provide: RENDER_SLOTS,
         multi: true,
         useFactory: () => {
           const arg = 'Hello';

           return {
             slot: ResourceSlot.HEAD_SCRIPTS,
             type: ResourceType.inlineScript,
             // обратите внимание, что добавляем используем функцию как будто пишем iife функцию, только вместо тела функции используем код импорт из модуля
             // при этом передаваемые строки надо дополнительно заключать в кавычки
             payload: `(${test})('${arg}')`,
           };
         },
       },
     ],
   })
   export class CustomModule {}
   ```

3. После сборки проекта и запуска страницы в браузере должен получить такой код, вместо изначального

   ```html
   <script>
     (function test(arg) {
       var Test = /*#__PURE__*/ (function () {
         function Test() {}

         var _proto = Test.prototype;

         _proto.log = function log() {
           console.log({
             arg: arg,
             a: 1,
           });
         };

         return Test;
       })();

       var t = new Test();
       t.log();
     })('Hello');
   </script>
   ```
